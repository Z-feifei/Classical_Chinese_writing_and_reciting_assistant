<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¸­å¿ƒ - æ–‡è¨€æ–‡å‡ºé¢˜åŠèƒŒè¯µåŠ©æ‰‹</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/recite.css') }}">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-image: url('/static/images/img.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            min-height: 100vh;
        }
        .header {
            background-color: #6d4427;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            font-size: 20px;
        }
        .header-links {
            display: flex;
            gap: 20px;
        }
        .header-links a {
            color: white;
            text-decoration: none;
            font-size: 14px;
        }
        .main-container {
            display: flex;
            margin: 20px;
            min-height: calc(100vh - 120px);
        }
        .sidebar {
            width: 200px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin-right: 20px;
            height: fit-content;
        }
        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar-menu li {
            margin-bottom: 15px;
        }
        .sidebar-menu li a {
            display: flex;
            align-items: center;
            color: #333;
            text-decoration: none;
            font-size: 14px;
            padding: 8px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .sidebar-menu li a:hover, .sidebar-menu li a.active {
            background-color: #6d4427;
            color: white;
        }
        .sidebar-menu li a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .content-section {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 20px;
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .section-header h2 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }
        .profile-info {
            display: flex;
            gap: 30px;
            align-items: center;
        }
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            color: #6d4427;
            position: relative;
            cursor: pointer;
            border: 3px solid #6d4427;
        }
        .profile-avatar:hover::after {
            content: "ç‚¹å‡»ä¿®æ”¹";
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #666;
        }
        .profile-details {
            flex: 1;
        }
        .profile-details p {
            margin: 8px 0;
            color: #555;
        }
        .profile-details strong {
            color: #333;
            margin-right: 5px;
        }
        .editable-field {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .editable-field input {
            border: 1px solid #ddd;
            padding: 5px 10px;
            border-radius: 5px;
            display: none;
        }
        .editable-field.editing input {
            display: inline-block;
        }
        .editable-field.editing span {
            display: none;
        }
        .edit-btn, .save-btn, .cancel-btn {
            background-color: #6d4427;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }
        .save-btn {
            background-color: #28a745;
        }
        .cancel-btn {
            background-color: #dc3545;
        }
        .study-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            flex: 1;
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #555;
        }
        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #6d4427;
        }
        .record-list {
            border-top: 1px solid #eee;
            padding-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .record-item {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }
        .record-item:last-child {
            border-bottom: none;
        }
        .record-item p {
            margin: 5px 0;
            color: #555;
        }
        .record-item strong {
            color: #333;
        }
        .action-btn {
            background-color: #6d4427;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        .action-btn.danger {
            background-color: #dc3545;
        }
        .action-btn:hover {
            opacity: 0.8;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 300px;
            text-align: center;
        }
        .modal-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #ccc;
        }
        .favorite-item {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #6d4427;
        }
        .favorite-item h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .favorite-item p {
            color: #666;
            margin: 5px 0;
            line-height: 1.5;
        }
        .favorite-item .actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        .favorite-item .btn-small {
            padding: 3px 8px;
            font-size: 12px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
        }
        .btn-small.view {
            background-color: #17a2b8;
            color: white;
        }
        .btn-small.delete {
            background-color: #dc3545;
            color: white;
        }
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .search-box input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .search-box button {
            padding: 5px 10px;
            border: none;
            background-color: #6d4427;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .search-box .show-all-btn {
            margin-left: 10px;
            background-color: #28a745;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="header">
        <h1>æ–‡è¨€æ–‡å‡ºé¢˜åŠèƒŒè¯µåŠ©æ‰‹</h1>
        <div class="header-links">
            <a href="{{ url_for('home') }}">é¦–é¡µ</a>
            <a href="{{ url_for('profile') }}">ä¸ªäººä¸­å¿ƒ</a>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="#profile-info" class="nav-link active" data-target="profile-info"><i class="fas fa-user"></i> ä¸ªäººåŸºæœ¬ä¿¡æ¯</a></li>
                <li><a href="#favorites" class="nav-link" data-target="favorites"><i class="fas fa-heart"></i> æ”¶è—</a></li>
                <li><a href="#study-records" class="nav-link" data-target="study-records"><i class="fas fa-book"></i> å­¦ä¹ è®°å½•</a></li>
                <li><a href="#account-settings" class="nav-link" data-target="account-settings"><i class="fas fa-cog"></i> è´¦å·ç®¡ç†</a></li>
                <li><a href="#" onclick="showLogoutModal()"><i class="fas fa-sign-out-alt"></i> é€€å‡º</a></li>
            </ul>
        </div>

        <div class="content-area">
            <!-- ä¸ªäººåŸºæœ¬ä¿¡æ¯ -->
            <div id="profile-info" class="content-section active">
                <div class="section-header">
                    <h2>ä¸ªäººåŸºæœ¬ä¿¡æ¯</h2>
                </div>

                <div class="profile-info">
                    <div class="profile-avatar" onclick="changeAvatar()">
                        {{ user.username[0] | upper }}
                    </div>
                    <div class="profile-details">
                        <p><strong>ç”¨æˆ·å:</strong> {{ user.username }}</p>
                        <div class="editable-field" id="personal-tag-field">
                            <strong>ä¸ªæ€§æ ‡ç­¾:</strong>
                            <span>{{ user.personal_tag or 'æš‚æ— ä¸ªæ€§æ ‡ç­¾' }}</span>
                            <input type="text" value="{{ user.personal_tag or '' }}" placeholder="è¾“å…¥ä¸ªæ€§æ ‡ç­¾">
                            <button class="edit-btn" onclick="editField('personal-tag-field')">ä¿®æ”¹</button>
                        </div>
                        <p><strong>é‚®ç®±:</strong> {{ user.email }}</p>
                        <p><strong>æ³¨å†Œæ—¶é—´:</strong> {{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    </div>
                </div>
            </div>

            <!-- æ”¶è— -->
            <div id="favorites" class="content-section">
                <div class="section-header">
                    <h2>æˆ‘çš„æ”¶è—</h2>
                    <span>å…± {{ user.favorites|length }} é¡¹</span>
                </div>

                <!-- æœç´¢æ¡† -->
                <div class="search-box">
                    <input type="text" id="favorite-search" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜...">
                    <button onclick="searchFavorites()"><i class="fas fa-search"></i></button>
                    <button onclick="showAllFavorites()" class="show-all-btn"><i class="fas fa-list"></i> æ˜¾ç¤ºæ‰€æœ‰</button>
                </div>
                
                <div id="favorites-list">
                    {% if user.favorites %}
                        {% for favorite in user.favorites %}
                            <div class="favorite-item">
                                <h4>{{ favorite.title }}</h4>
                                <p>{{ favorite.content[:200] }}{% if favorite.content|length > 200 %}...{% endif %}</p>
                                <p><small>æ”¶è—æ—¶é—´ï¼š{{ favorite.created_at.strftime('%Y-%m-%d %H:%M') }}</small></p>
                                <div class="actions">
                                    <button class="btn-small view" onclick="viewFavorite('{{ favorite.id }}')">æŸ¥çœ‹è¯¦æƒ…</button>
                                    <button class="btn-small delete" onclick="deleteFavorite('{{ favorite.id }}')">åˆ é™¤</button>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-heart"></i>
                            <p>æš‚æ— æ”¶è—å†…å®¹</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- å­¦ä¹ è®°å½• -->
            <div id="study-records" class="content-section">
                <div class="section-header">
                    <h2>å­¦ä¹ è®°å½•</h2>
                    <a href="{{ url_for('history') }}">æŸ¥çœ‹å…¨éƒ¨</a>
                </div>

                <div class="study-stats">
                    <div class="stat-card">
                        <h3>å­¦ä¹ è®°å½•æ•°</h3>
                        <div class="value">{{ user.study_records|length }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>å­¦ä¹ å¤©æ•°</h3>
                        <div class="value">{{ user.study_records|length }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>å­¦ä¹ è¿›åº¦</h3>
                        <div class="value">{{ (user.study_records|length * 5)|int }}%</div>
                    </div>
                </div>

                {% if records %}
                    <div class="record-list">
                        {% for record in records %}
                            <div class="record-item">
                                <p><strong>å­¦ä¹ æ—¶é—´:</strong> {{ record.study_time.strftime('%Y-%m-%d %H:%M') }}</p>
                                <p><strong>æ–‡ç« å†…å®¹:</strong> {{ record.article_content[:100] }}{% if record.article_content|length > 100 %}...{% endif %}</p>
                                {% if record.score %}
                                    <p><strong>å¾—åˆ†:</strong> {{ record.score }}</p>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-book"></i>
                        <p>æš‚æ— å­¦ä¹ è®°å½•</p>
                    </div>
                {% endif %}
            </div>

            <!-- è´¦å·ç®¡ç† -->
            <div id="account-settings" class="content-section">
                <div class="section-header">
                    <h2>è´¦å·ç®¡ç†</h2>
                </div>

                <div style="background-color: #f9f9f9; padding: 20px; border-radius: 8px;">
                    <p><strong>ç»‘å®šé‚®ç®±:</strong> {{ user.email }}</p>
                    <button class="action-btn" onclick="location.href='{{ url_for('reset_password') }}'">
                        <i class="fas fa-key"></i> ä¿®æ”¹å¯†ç 
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- é€€å‡ºç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <h3>ç¡®è®¤é€€å‡º</h3>
            <p>æ˜¯å¦é€€å‡ºå½“å‰è´¦å·ï¼Ÿ</p>
            <div class="modal-buttons">
                <button class="action-btn" onclick="confirmLogout()">é€€å‡º</button>
                <button class="action-btn" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // å¯¼èˆªåˆ‡æ¢
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();

                // ç§»é™¤æ‰€æœ‰activeç±»
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));

                // æ·»åŠ activeç±»
                this.classList.add('active');
                const targetId = this.getAttribute('data-target');
                document.getElementById(targetId).classList.add('active');
            });
        });

        // ç¼–è¾‘å­—æ®µ
        function editField(fieldId) {
            const field = document.getElementById(fieldId);
            const isEditing = field.classList.contains('editing');

            if (isEditing) {
                // ä¿å­˜
                const input = field.querySelector('input');
                const span = field.querySelector('span');
                const newValue = input.value;

                // è¿™é‡Œå¯ä»¥æ·»åŠ AJAXè¯·æ±‚ä¿å­˜åˆ°æœåŠ¡å™¨
                fetch('/update_profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `field=personal_tag&value=${encodeURIComponent(newValue)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        span.textContent = newValue || 'æš‚æ— ä¸ªæ€§æ ‡ç­¾';
                        field.classList.remove('editing');
                        field.querySelector('button').textContent = 'ä¿®æ”¹';
                    }
                });
            } else {
                // ç¼–è¾‘
                field.classList.add('editing');
                field.querySelector('button').textContent = 'ä¿å­˜';
                field.querySelector('input').focus();
            }
        }

        // æ›´æ¢å¤´åƒ
        function changeAvatar() {
            const avatars = ['ğŸ˜Š', 'ğŸ“', 'ğŸ“š', 'âœï¸', 'ğŸŒŸ', 'ğŸ¯', 'ğŸ’¡', 'ğŸ”¥'];
            const current = document.querySelector('.profile-avatar').textContent.trim();
            let next = avatars[Math.floor(Math.random() * avatars.length)];

            // ç¡®ä¿ä¸æ˜¯åŒä¸€ä¸ªå¤´åƒ
            while (next === current) {
                next = avatars[Math.floor(Math.random() * avatars.length)];
            }

            document.querySelector('.profile-avatar').textContent = next;

            // ä¿å­˜åˆ°æœåŠ¡å™¨
            fetch('/update_profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `field=avatar&value=${encodeURIComponent(next)}`
            });
        }

        // æ˜¾ç¤ºé€€å‡ºæ¨¡æ€æ¡†
        function showLogoutModal() {
            document.getElementById('logoutModal').style.display = 'block';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('logoutModal').style.display = 'none';
        }

        // ç¡®è®¤é€€å‡º
        function confirmLogout() {
            window.location.href = '{{ url_for("logout") }}';
        }

        // æŸ¥çœ‹æ”¶è—è¯¦æƒ…
        function viewFavorite(id) {
            // è¿™é‡Œå¯ä»¥æ‰“å¼€è¯¦æƒ…é¡µé¢æˆ–æ¨¡æ€æ¡†
            window.location.href = `/favorite_detail/${id}`;
        }

        // åˆ é™¤æ”¶è—
        function deleteFavorite(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ”¶è—å—ï¼Ÿ')) {
                fetch(`/delete_favorite/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                });
            }
        }
        
        // æœç´¢æ”¶è—
        function searchFavorites() {
            const query = document.getElementById('favorite-search').value;
            
            fetch(`/search_favorites?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateFavoritesList(data.favorites);
                }
            });
        }
        
        // æ˜¾ç¤ºæ‰€æœ‰æ”¶è—
        function showAllFavorites() {
            document.getElementById('favorite-search').value = '';
            
            // ä½¿ç”¨APIè·å–æ‰€æœ‰æ”¶è—
            fetch('/search_favorites')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateFavoritesList(data.favorites);
                }
            });
        }
        
        // æ›´æ–°æ”¶è—åˆ—è¡¨
        function updateFavoritesList(favorites) {
            const favoritesList = document.getElementById('favorites-list');
            favoritesList.innerHTML = '';
            
            if (favorites.length > 0) {
                favorites.forEach(favorite => {
                    favoritesList.innerHTML += `
                        <div class="favorite-item">
                            <h4>${favorite.title}</h4>
                            <p>${favorite.content}</p>
                            <p><small>æ”¶è—æ—¶é—´ï¼š${favorite.created_at}</small></p>
                            <div class="actions">
                                <button class="btn-small view" onclick="viewFavorite('${favorite.id}')">æŸ¥çœ‹è¯¦æƒ…</button>
                                <button class="btn-small delete" onclick="deleteFavorite('${favorite.id}')">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                });
            } else {
                favoritesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>æœªæ‰¾åˆ°ç›¸å…³æ”¶è—</p>
                    </div>
                `;
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('logoutModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>